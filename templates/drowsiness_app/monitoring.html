{% extends 'base.html' %}

{% block title %}Monitoring Session - SEDDS{% endblock %}

{% block extra_css %}
<style>
    .monitoring-container {
        background: rgba(0,0,0,0.8);
        border-radius: 15px;
        padding: 20px;
    }
    
    .video-feed {
        width: 100%;
        height: auto;
        border-radius: 10px;
        border: 3px solid #28a745;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
    }
    
    .status-indicator {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(40, 167, 69, 0.9);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
    }
    
    .status-indicator.alert {
        background: rgba(220, 53, 69, 0.9);
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.5; }
    }
    
    .session-stats {
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 15px;
        color: white;
        margin-bottom: 15px;
    }
    
    .stat-item {
        text-align: center;
        padding: 10px;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .control-buttons {
        gap: 10px;
    }
    
    .btn-stop {
        background: linear-gradient(45deg, #dc3545, #c82333);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-stop:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        color: white;
    }
    
    .alert-log {
        max-height: 200px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        color: #212529;
    }
    
    .alert-item {
        padding: 8px 10px;
        margin-bottom: 8px;
        background: white;
        border-left: 3px solid #ffc107;
        border-radius: 5px;
        font-size: 0.9rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        color: #212529;
    }
    
    .alert-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="monitoring-status">
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-video me-2"></i>
        <strong>Monitoring Active</strong> - Your study session is being monitored for drowsiness.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<div class="row">
    <!-- Video Feed Section -->
    <div class="col-lg-8 mb-4">
        <div class="monitoring-container position-relative">
            <div class="status-indicator" id="statusIndicator">
                <i class="fas fa-circle me-1"></i>MONITORING
            </div>
            
            <img src="{% url 'video_feed' %}" class="video-feed" alt="Video Feed" id="videoFeed">
            
            <div class="text-center mt-3">
                <div class="control-buttons d-flex justify-content-center">
                    <button class="btn btn-stop" onclick="stopMonitoring()">
                        <i class="fas fa-stop me-2"></i>Stop Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics and Controls -->
    <div class="col-lg-4">
        <!-- Session Statistics -->
        <div class="session-stats">
            <h5 class="text-center mb-3">
                <i class="fas fa-chart-line me-2"></i>Session Stats
            </h5>
            
            <div class="row">
                <div class="col-6 stat-item">
                    <span class="stat-number" id="sessionDuration">00:00:00</span>
                    <span class="stat-label">Duration</span>
                </div>
                <div class="col-6 stat-item">
                    <span class="stat-number" id="alertCount">0</span>
                    <span class="stat-label">Alerts</span>
                </div>
            </div>
            
            <div class="row mt-2">
                <div class="col-6 stat-item">
                    <span class="stat-number" id="sessionStart">--:--</span>
                    <span class="stat-label">Started</span>
                </div>
                <div class="col-6 stat-item">
                    <span class="stat-number" id="currentTime">--:--</span>
                    <span class="stat-label">Current</span>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Instructions
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Position yourself clearly in the camera view
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Ensure good lighting on your face
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Keep system volume on for alerts
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success me-2"></i>
                        Focus on your studies - we'll monitor you!
                    </li>
                </ul>
            </div>
        </div>

        <!-- Alert Log -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bell me-2"></i>Alert Log
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="alert-log" id="alertLog">
                    <div class="text-center text-muted py-3" style="color: #6c757d;">
                        <i class="fas fa-clock me-2"></i>No alerts yet - keep studying!
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="stopConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-stop me-2"></i>Stop Monitoring Session
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to stop the current monitoring session?</p>
                <p class="text-muted">Your session data will be saved and you'll be redirected to the session report.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmStop()">
                    <i class="fas fa-stop me-2"></i>Stop Session
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let sessionStartTime = new Date();
let alertCount = 0;
let sessionInterval;
let statsInterval;

// Initialize monitoring
document.addEventListener('DOMContentLoaded', function() {
    startSessionTimer();
    startStatsUpdater();
    updateCurrentTime();
    
    // Update current time every second
    setInterval(updateCurrentTime, 1000);
});

function startSessionTimer() {
    sessionInterval = setInterval(function() {
        const now = new Date();
        const duration = new Date(now - sessionStartTime);
        const hours = String(duration.getUTCHours()).padStart(2, '0');
        const minutes = String(duration.getUTCMinutes()).padStart(2, '0');
        const seconds = String(duration.getUTCSeconds()).padStart(2, '0');
        
        document.getElementById('sessionDuration').textContent = `${hours}:${minutes}:${seconds}`;
    }, 1000);
}

function startStatsUpdater() {
    // Update session stats every 5 seconds
    statsInterval = setInterval(function() {
        fetch('{% url "session_stats" %}')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'active') {
                    document.getElementById('alertCount').textContent = data.alert_count;
                    document.getElementById('sessionStart').textContent = data.session_start;
                    
                    // Update alert count if changed
                    if (data.alert_count > alertCount) {
                        alertCount = data.alert_count;
                        addAlertToLog();
                        showAlertStatus();
                    }
                }
            })
            .catch(error => console.error('Error fetching stats:', error));
    }, 5000);
}

function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('currentTime').textContent = timeString;
}

function addAlertToLog() {
    const alertLog = document.getElementById('alertLog');
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    
    // Remove "no alerts" message if present
    if (alertLog.querySelector('.text-muted')) {
        alertLog.innerHTML = '';
    }
    
    const alertItem = document.createElement('div');
    alertItem.className = 'alert-item';
    alertItem.innerHTML = `
        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
        <strong>Drowsiness Alert</strong> - ${timeString}
    `;
    
    alertLog.insertBefore(alertItem, alertLog.firstChild);
    
    // Keep only last 10 alerts
    const alerts = alertLog.querySelectorAll('.alert-item');
    if (alerts.length > 10) {
        alertLog.removeChild(alerts[alerts.length - 1]);
    }
}

function showAlertStatus() {
    const statusIndicator = document.getElementById('statusIndicator');
    statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>ALERT DETECTED';
    statusIndicator.classList.add('alert');
    
    // Reset status after 3 seconds
    setTimeout(function() {
        statusIndicator.innerHTML = '<i class="fas fa-circle me-1"></i>MONITORING';
        statusIndicator.classList.remove('alert');
    }, 3000);
}

function stopMonitoring() {
    const modal = new bootstrap.Modal(document.getElementById('stopConfirmModal'));
    modal.show();
}

function confirmStop() {
    // Clear intervals
    if (sessionInterval) clearInterval(sessionInterval);
    if (statsInterval) clearInterval(statsInterval);
    
    // Redirect to stop monitoring
    window.location.href = '{% url "stop_monitoring" %}';
}

// Handle page unload
window.addEventListener('beforeunload', function(e) {
    // Clear intervals
    if (sessionInterval) clearInterval(sessionInterval);
    if (statsInterval) clearInterval(statsInterval);
});

// Handle visibility change (tab switching)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Page is hidden - could pause some updates
        console.log('Page hidden - monitoring continues in background');
    } else {
        // Page is visible - resume full functionality
        console.log('Page visible - full monitoring active');
    }
});
</script>
{% endblock %}